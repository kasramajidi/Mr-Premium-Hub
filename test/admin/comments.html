<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>انتقادات و پیشنهادات | پنل مدیریت ريتكس</title>
  <link rel="icon" href="../Images/Logo/Raitx%20international%20payments%20logo%20design%20(1).png">
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="stylesheet" href="../css/admin.css">
</head>
<body>
  <div class="admin-wrap">
    <aside class="admin-sidebar" id="admin-sidebar"></aside>
    <main class="admin-main">
      <h1 class="admin-page-title">انتقادات و پیشنهادات</h1>
      <p class="admin-page-desc">مدیریت نظرات و درخواست‌ها. داده از API (action=ExamRegister) مطابق raitx-platform.</p>
      <div id="admin-comments-list" class="admin-card">
        <div class="admin-card-header"><h3>لیست انتقادات و پیشنهادات</h3></div>
        <div style="padding:2rem;text-align:center;color:#6b7280;">در حال بارگذاری…</div>
      </div>
    </main>
  </div>
  <script src="../js/api.js"></script>
  <script src="../js/admin-layout.js"></script>
  <script>
    (function () {
      if (!adminLayout.isLoggedIn()) { window.location.href = 'login.html?next=comments.html'; return; }
      adminLayout.renderSidebar('admin-sidebar');
      var API = (typeof API_BASE !== 'undefined' && API_BASE()) ? API_BASE() : 'https://mrpremiumhub.org/api.ashx';
      var el = document.getElementById('admin-comments-list');
      function fmtDate(v) {
        if (v == null || v === '') return '—';
        try {
          var d = typeof v === 'number' ? new Date(v) : new Date(String(v));
          return isNaN(d.getTime()) ? String(v) : new Intl.DateTimeFormat('fa-IR', { year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' }).format(d);
        } catch (e) { return String(v); }
      }
      function load() {
        fetch(API + '?action=ExamRegister')
          .then(function (r) { return r.json(); })
          .then(function (data) {
            var list = Array.isArray(data) ? data : (data && (data.data || data.list || data.items)) || [];
            if (list.length === 0) {
              el.innerHTML = '<div class="admin-card-header"><h3>لیست انتقادات و پیشنهادات</h3></div><div style="padding:2rem;text-align:center;color:#6b7280;">موردی یافت نشد.</div>';
              return;
            }
            var rows = list.map(function (c) {
              var id = c.id || c.ID || c.Id || '';
              var title = (c.title || c.Title || '').toString().substring(0, 25);
              var name = (c.name || c.Name || c.author || '').toString().substring(0, 20);
              var email = (c.email || c.Email || '').toString().substring(0, 25);
              var phone = (c.phone || c.Phone || '').toString().substring(0, 15);
              var comment = (c.comment || c.Comment || c.content || c.text || '').toString().substring(0, 50);
              var date = fmtDate(c.date || c.Date || c.createdAt || c.registerDate);
              return '<tr><td>' + id + '</td><td>' + title + '</td><td>' + name + '</td><td>' + email + '</td><td>' + phone + '</td><td>' + comment + '</td><td>' + date + '</td><td><button type="button" class="btn-sm btn-delete" data-id="' + id + '">حذف</button></td></tr>';
            }).join('');
            el.innerHTML = '<div class="admin-card-header"><h3>لیست انتقادات و پیشنهادات</h3></div><div class="overflow-x-auto"><table class="admin-table"><thead><tr><th>شناسه</th><th>عنوان</th><th>نام</th><th>ایمیل</th><th>تلفن</th><th>متن</th><th>تاریخ</th><th>عملیات</th></tr></thead><tbody>' + rows + '</tbody></table></div>';
            el.querySelectorAll('.btn-delete').forEach(function (btn) {
              btn.addEventListener('click', function () {
                var id = btn.getAttribute('data-id');
                if (!id || !confirm('آیا از حذف این مورد اطمینان دارید؟')) return;
                fetch(API + '?action=ExamRegister&id=' + encodeURIComponent(id), { method: 'DELETE', headers: { 'Content-Type': 'application/json' } })
                  .then(function () { load(); })
                  .catch(function () { load(); });
              });
            });
          })
          .catch(function () {
            el.innerHTML = '<div class="admin-card-header"><h3>لیست انتقادات و پیشنهادات</h3></div><div style="padding:2rem;text-align:center;color:#6b7280;">خطا در بارگذاری از API.</div>';
          });
      }
      load();
    })();
  </script>
</body>
</html>
